<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<title data-react-helmet="true">上传视频内存优化 | KRN 文档</title><meta data-react-helmet="true" property="og:title" content="上传视频内存优化 | KRN 文档"><meta data-react-helmet="true" name="description" content="项目中使用 react-native-fs 上传视频时经常出现内存暴涨，内存上涨的幅度是视频大小的 2 倍，而且这部分内存随后没有释放；如此反复上传视频最终导致 App 内存不足而崩溃"><meta data-react-helmet="true" property="og:description" content="项目中使用 react-native-fs 上传视频时经常出现内存暴涨，内存上涨的幅度是视频大小的 2 倍，而且这部分内存随后没有释放；如此反复上传视频最终导致 App 内存不足而崩溃"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.d4cf7885.css">
<link rel="preload" href="/styles.b449aec6.js" as="script">
<link rel="preload" href="/runtime~main.d1c5f546.js" as="script">
<link rel="preload" href="/main.6901dc36.js" as="script">
<link rel="preload" href="/1.bdbdbd37.js" as="script">
<link rel="preload" href="/2.bd3da52e.js" as="script">
<link rel="preload" href="/3.ded2d30c.js" as="script">
<link rel="preload" href="/ccc49370.21263af8.js" as="script">
<link rel="preload" href="/b0a3ab04.77304d02.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">KRN 文档</strong></a><a class="navbar__item navbar__link" href="/docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a href="https://kwairn.github.io/components/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Components</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">KRN 文档</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Docs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://kwairn.github.io/components/" target="_blank" rel="noopener noreferrer" class="menu__link">Components</a></li><li class="menu__list-item"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">上传视频内存优化</h1><div class="margin-vert--md"><time datetime="2020-07-31T00:00:00.000Z" class="blogPostDate_3bQP">July 31, 2020  · 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/norcy" target="_blank" rel="noreferrer noopener"><img src="https://avatars3.githubusercontent.com/u/8423011?s=460&amp;u=2cc946eff5c03df2f3afd1665cd2a63ffe26eda1&amp;v=4" alt="ChenYing"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/norcy" target="_blank" rel="noreferrer noopener">ChenYing</a></h4><small class="avatar__subtitle">😷</small></div></div></header><section class="markdown"><p>项目中使用 <a href="https://github.com/itinance/react-native-fs" target="_blank" rel="noopener noreferrer">react-native-fs</a> 上传视频时经常出现内存暴涨，内存上涨的幅度是视频大小的 2 倍，而且这部分内存随后没有释放；如此反复上传视频最终导致 App 内存不足而崩溃</p><p>查看了其源码的时候，发现有两个问题导致内存泄漏</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="第一个问题"></a>第一个问题<a aria-hidden="true" tabindex="-1" class="hash-link" href="#第一个问题" title="Direct link to heading">#</a></h2><p>这段代码是发送上传请求</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[_task resume];</span></div></div></div></div></div><p>第一个问题是 <code>sessionWithConfiguration:delegate:delegateQueue:</code> 中的 delegate 参数会被 NSURLSession 强引用，会导致 delegate 也就是 self 永久不会释放，这点该接口已经有官方文档的说明</p><blockquote><p>The session object keeps a strong reference to the delegate until your app exits or explicitly invalidates the session. If you do not invalidate the session by calling the invalidateAndCancel or finishTasksAndInvalidate method, your app leaks memory until it exits</p></blockquote><p>解决方法是在任务结束时调用 invalidateAndCancel 或 finishTasksAndInvalidate，如下</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [session finishTasksAndInvalidate];   // 释放 delegate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="第二个问题"></a>第二个问题<a aria-hidden="true" tabindex="-1" class="hash-link" href="#第二个问题" title="Direct link to heading">#</a></h2><p>发现上传的关键代码如下，上传大文件的时候，使用的是先读取文件到内存，然后设置到 HTTPBody。</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSData *fileData = [NSData dataWithContentsOfFile:filepath];    // 这里内存会上涨一个视频的大小</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[reqBody appendData:fileData];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[req setHTTPBody:reqBody];      // 这里内存也会上涨一个视频的大小</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//sessionConfiguration.requestCachePolicy = NSURLRequestReloadIgnoringLocalAndRemoteCacheData; 尝试过没用</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session dataTaskWithRequest:req completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  [session finishTasksAndInvalidate];   // 释放 delegate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  NSString * str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return self-&gt;_params.completeCallback(str, response); // 网络请求完成，内存没有降下来，总共上涨了 2 个视频的大小</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[_task resume];</span></div></div></div></div></div><p>原因是 NSURLSession 会 retain 了 req 里的 data，所以出现内存不释放问题</p><p>对于大文件的上传应该使用流式上传的方式</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-objc codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:(id)self delegateQueue:[NSOperationQueue mainQueue]];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">_task = [session uploadTaskWithRequest:req</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                              fromFile:fileUrl</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     completionHandler:^(NSData *_Nullable data, NSURLResponse *_Nullable response,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                         NSError *_Nullable error) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        [session finishTasksAndInvalidate];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        NSString *str = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return self-&gt;_params.completeCallback(str, response);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                     }];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>这段代码取消了直接读取文件然后设置 HTTPBody 的做法，并用 <code>uploadTaskWithRequest:fromFile:completionHandler:</code> 方法来上传文件，流式发送，读取一点发送一点，这种做法实践下来内存十分稳定</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="完整代码"></a>完整代码<a aria-hidden="true" tabindex="-1" class="hash-link" href="#完整代码" title="Direct link to heading">#</a></h2><p><a href="http://git.corp.kuaishou.com/team-shenzhen/ios/react-native-fs" target="_blank" rel="noopener noreferrer">完整代码</a></p></section></article><div><a href="https://github.com/facebook/docusaurus/edit/source/website/blog/blog/2020-07-31-videom-memory.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/start/">Getting Start</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/KwaiRN/KwaiRN.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.b449aec6.js"></script>
<script src="/runtime~main.d1c5f546.js"></script>
<script src="/main.6901dc36.js"></script>
<script src="/1.bdbdbd37.js"></script>
<script src="/2.bd3da52e.js"></script>
<script src="/3.ded2d30c.js"></script>
<script src="/ccc49370.21263af8.js"></script>
<script src="/b0a3ab04.77304d02.js"></script>
</body>
</html>